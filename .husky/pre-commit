#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "Running pre-commit checks..."

# 1) lint-staged
npx lint-staged || exit 1

# 2) type-check
npm run type-check || exit 1

# 3) Sensitive data scan (exclude docs/legacy/**)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)
FILTERED_FILES=$(echo "$STAGED_FILES" | grep -v "^docs/legacy/" | grep -v "^node_modules/")

if [ -n "$FILTERED_FILES" ]; then
  # VIN (generisk)
  if echo "$FILTERED_FILES" | xargs grep -l "\b[A-HJ-NPR-Z0-9]{17}\b" 2>/dev/null; then
    echo "❌ VIN-nummer upptäckt i commit! Maskera eller ta bort."
    exit 1
  fi
  # Svenskt reg.nr
  if echo "$FILTERED_FILES" | xargs grep -l "\b[A-Z]{3}\s*[0-9]{2}[A-Z0-9]\b" 2>/dev/null; then
    echo "❌ Registreringsnummer upptäckt i commit! Maskera eller ta bort."
    exit 1
  fi
  # Personnummer
  if echo "$FILTERED_FILES" | xargs grep -l "\b[0-9]{6}-[0-9]{4}\b" 2>/dev/null; then
    echo "❌ Personnummer upptäckt i commit!"
    exit 1
  fi
fi

echo "✅ Pre-commit checks passed!"
